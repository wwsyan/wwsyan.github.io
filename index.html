<!DOCTYPE html>
<html>
  <head>
  
  <style>
    body {
      background-image: url(images/fruits.jpg);
    }
  
    #title {
      text-align: center;
      color: rgb(248, 38, 84);
      padding: 15px;
      font-weight: bolder;
      font-size: 40px;
      -webkit-text-stroke: 1px black;
      text-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
    }

    #title:hover {
      transform: scale(1.1);
      cursor: pointer;
    }

    #grid {
      margin: auto;
    }

    .blocks {
        width: 30px;
        height: 30px;
        line-height: 30px;
        display: block;   /* è®©spanä»¥blockæ–¹å¼æ˜¾ç¤º */
        text-align: center;
        user-select: none;  /* è®¾ç½®ä¸å¯æ‹–æ‹½é€‰ä¸­ */
        cursor: pointer;  /* è®¾ç½®é¼ æ ‡åœç•™æ ·å¼ */
        box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
     }

    .blocks:hover {
            background: rgb(255, 188, 235);  /* é¼ æ ‡åœç•™æ—¶èƒŒæ™¯é¢œè‰²å˜åŒ– */
            transform: scale(1.2);
        }

    .blocks_1 {
        border: transparent;
        background-color: rgb(117, 182, 117);
        border-radius: 15%;
        font-weight: bold;
      }

    .banClick {
      pointer-events: none;
    }

    #gameStart {
      width: 16%;
      float: left;
      text-align: center;
      padding-top: 10px;
    }

    #playerScoleBox {
      width: 15%;
      float: left;
    }

    #computerScoleBox {
      width: 15%;
      float: left;
    }

    #button {
      font-size: 25px;
      font-weight: bold;
      border-radius: 20%;
      padding: 8px;
    }

    #button:hover {
      transform: scale(1.2);
      animation-name: shake;
      animation-duration: 0.5s;
      animation-iteration-count: infinite;
    }

    @keyframes shake {
      0% {
        transform: rotate(0deg);
      }
      25% {
        transform: rotate(-5deg);
      }
      50% {
        transform: rotate(0deg);
      }
      75% {
        transform: rotate(5deg);
      }
      100% {
        transform: rotate(0deg);
      }
    }

    @keyframes rotate {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes scale {
      0% {
        transform: scale(1.0);
      }
      100% {
        transform: scale(1.2);
      }
    }

    p {
      font-size: 20px;
      font-weight: 900;
      color: black;
      /* -webkit-text-stroke: 1px white; */
      text-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
      text-align: center;
    }

    h2 {
      width: 27%;
      float: left;
      color: transparent;
      text-align: center;
    }

  </style>
  <!-- ç›®å‰å¤§éƒ¨åˆ†ä¸»æµæµè§ˆå™¨ä¸æ”¯æŒautoplay -->
   <audio id="bgm" src="sound\throwback-galaxy.mp3" loop preload="auto"></audio>
  </head>

<!-- ondragstart:é˜²æ‹–æ‹½ç”Ÿæˆæ–°é¡µé¢ oncontextmenu:å±è”½å³é”®èœå•-->

<body ondragstart='return false' oncontextmenu='self.event.returnValue=false'>
  
  <h1 id = 'title' onmousedown="titleControlBGM()">æ‰¾æœæœğŸ“</h1>
  <table id='grid'></table>
  <div>
  <h2>å¡«å……ç‰©</h2>
  <div id = 'playerScoleBox'><p id = 'playerScole'>ç©å®¶å¾—åˆ†ï¼š0</p></div>
  <div id = 'gameStart'><button id = "button">å¼€å§‹æ¸¸æˆ</button></div>
  <div id = 'computerScoleBox'><p id = 'computerScole'>ç”µè„‘å¾—åˆ†ï¼š0</p></div>
  <h2>å¡«å……ç‰©</h2>
  </div>
  

  <script>
    const testButton = document.getElementById('button');
    const playerScolePara = document.getElementById('playerScole');
    const computerScolePara = document.getElementById('computerScole');
    const bgm = document.getElementById('bgm');
    var row = 12; //è¡Œæ•°
    var col = 12; //åˆ—æ•°
    var maxCount = 20; //æœ€å¤§åœ°é›·æ•°é‡
    var playerScole = 0;
    var computerScole = 0;
    var grid = init_grid(); //åˆå§‹åŒ–
    for (i = 0; i < row; i++) {
      for (j = 0; j < col; j++) {
        grid[i][j].isOpen = true;
      }
    }

    function titleControlBGM() {
      if (bgm.volume > 0) {
        bgm.volume = 0;
      }
      else {
        bgm.volume = 0.5;
      }
      
    }

    //åˆå§‹åŒ–çŸ©é˜µ (row-è¡Œæ•° col-åˆ—æ•°)
    function init_grid() {

      //ç”ŸæˆçŸ©é˜µhtml <tr>--è¡Œæ ‡ç­¾ <td>--åˆ—æ ‡ç­¾
      let gridHtml = '';
      for (let i = 0; i < row; i++) {
        gridHtml += '<tr>'
        for (let j = 0; j < col; j++) {
          gridHtml +=
            '<td><span class="blocks blocks_1" onmousedown="block_click(' + i + ',' + j + ')"></span></td>';
        }
        gridHtml += '<tr>'
      }
      //å†™å…¥html
      document.getElementById('grid').innerHTML = gridHtml;

      //è¿”å›çŸ©é˜µäºŒç»´æ•°ç»„
      let blocks = document.getElementsByClassName('blocks_1');
      let grid = new Array();
      for (let i = 0; i < blocks.length; i++) {
        if (i % col === 0) {
          grid.push(new Array());
        }
        //åˆå§‹åŒ–è®¡é›·æ•°
        blocks[i].tip = 0;
        grid[parseInt(i / col)].push(blocks[i]);
        grid[Math.floor(i / col)][i % col].worthOpen = true; 
      }
      return grid;
    }


    //åˆå§‹åŒ–æ¦‚ç‡é˜µ
    function init_proMat() {
      let proMat = new Array();
      for (i = 0; i < row; i++) {
        proMat.push(new Array());
        for (j = 0; j < col; j++) {
            proMat[i].push(0);
        }
      }
      return proMat;
    }


    //æ–¹æ ¼ç‚¹å‡»äº‹ä»¶ _iï¼šåæ ‡i _j:åæ ‡j
    function block_click(_i, _j) {

      //è·³è¿‡å·²æ‰“å¼€çš„æ–¹æ ¼
      if (grid[_i][_j].isOpen) {
        return;
      }

      //é¼ æ ‡å·¦é”®æ‰“å¼€æ–¹æ ¼
      if (event.button === 0) {
        //æ‰§è¡Œæ‰“å¼€æ–¹æ ¼å‡½æ•°
        block_open(_i, _j);
        if (playerScole === Math.floor(maxCount/2) + 1) {
          alert('ä½ èƒœåˆ©äº†ï¼');
          showRestMine();
          return;
        }
        if (playerScole === computerScole && playerScole === maxCount/2) {
          alert('æˆ˜å¹³ï¼');
          showRestMine();
          return;
        }
        
        // ç”µè„‘æ‰“å¼€æ–¹å—
        computer_click();
        if (computerScole === Math.floor(maxCount/2) + 1) {
          alert('å®³ï¼Œç”µè„‘èƒœåˆ©äº†');
          showRestMine();
          return;
        }
        if (computerScole === playerScole && computerScole === maxCount/2) {
          alert('æˆ˜å¹³ï¼');
          showRestMine();
          return;
        }
      }
    }

    function showRestMine() {
      for (i = 0; i < row; i++) {
        for (j = 0; j < col; j++) {
          grid[i][j].isOpen = true;
          if (grid[i][j].isMine) {
            grid[i][j].innerHTML = 'ğŸ“';
          }
        }
      }
    }


    // ç”µè„‘æ‰“å¼€æ–¹æ ¼æ€»ä½“äº‹ä»¶ï¼ˆè®¡ç®—æ¦‚ç‡ => ç‚¹å‡»æ–¹å—ï¼‰
    function computer_click() {
      var proMat = init_proMat();
      // æ’é™¤ä¸å¯èƒ½æ˜¯é›·çš„æ–¹æ ¼ï¼Œå³å¯¹blockçš„è‡ªå®šä¹‰å±æ€§worthOpenèµ‹å€¼ï¼šblock.worthOpen = fasle
      for (i = 0; i < row; i++) {
        for (j = 0; j < col; j++) {
          if (grid[i][j].isOpen && !grid[i][j].isMine) {
            countOpenMine = 0;

            for (_i = i-1; _i <= i+1; _i++ ) {
              for (_j = j-1; _j <= j+1; _j++) {
                if (_i >=0 && _j >=0 && _i < row && _j < col) {
                  block = grid[_i][_j];
                  if (block.isMine && block.isOpen) {countOpenMine++;}
                }
              }
            }

            if (grid[i][j].tip === countOpenMine) {
              for (_i = i-1; _i <= i+1; _i++) {
                for (_j = j-1; _j <= j+1; _j++) {
                  if (_i >=0 && _j >=0 && _i < row && _j < col && !grid[_i][_j].isOpen) {
                    grid[_i][_j].worthOpen = false; 
                  }
                }
              }
            }

          }
        }
      }
          
      // è®¡ç®—æ¦‚ç‡çŸ©é˜µï¼šproMat[i][j] = block.tip - countOpenMine / countWorthOpenMine
      for(i = 0; i < row; i++) {
        for(j = 0; j < col; j++) {

          if (grid[i][j].isOpen && !grid[i][j].isMine) {
            countOpenMine = 0;
            countWorthOpenMine = 0;

            for (_i = i-1; _i <= i+1; _i++) {
              for (_j = j-1; _j <= j+1; _j++) {
                if (_i >=0 && _j >=0 && _i < row && _j < col) {
                  block = grid[_i][_j];
                  if (block.isMine && block.isOpen) {countOpenMine++;}
                  if (block.worthOpen) {countWorthOpenMine++;} 
                }
              }
            }
            if (countWorthOpenMine > 0) {proMat[i][j] = ( grid[i][j].tip - countOpenMine ) / countWorthOpenMine;}
          }
        }
      }
      console.log(proMat);

      // æ‰¾å‡º max(proMat[i][j]) å¯¹åº”çš„iå’Œj
      [maxi,maxj] = findMaxij(proMat);
      console.log('maxij: ' + maxi + ' ' + maxj);

      function findMaxij(Mat) {
        max_i = -1;
        max_j = -1;
        array = new Array();
        for (i = 0; i < row; i++) {
          for (j = 0; j < col; j++) {
            array.push(proMat[i][j]);
          }
        }
        max = Math.max(...array)
        console.log('maxPro: ' + max);
        if (max > 0) {
          maxIndice = array.findIndex( (element) => element == max );
          max_i = Math.floor(maxIndice / col);
          max_j = maxIndice % col;
        }
        return [max_i,max_j];
      }

      // å¦‚æœä¸å­˜åœ¨ maxijï¼Œåˆ™éšæœºç‚¹ä¸€ä¸ªworthOpençš„æ–¹å—ï¼Œè¿”å›di dj
      if (maxi === -1 && maxj === -1) {
        count = 0;
        while (count < 1) {
          ri = Math.floor(Math.random() * row);
          rj = Math.floor(Math.random() * col);
          console.log('rij: ' + ri + ' ' + rj);
          if (!grid[ri][rj].isOpen && grid[ri][rj].worthOpen) {
            di = ri; dj = rj;
            count++;
          }
        }
      }
      // å¦‚æœå­˜åœ¨ maxijï¼Œåˆ™åœ¨maxijçš„èŒƒå›´å†…éšæœºç‚¹ä¸€ä¸ªworthOpençš„æ–¹å—ï¼Œè¿”å›di dj
      else  {
        arrayOpen = new Array();
        for (i = maxi-1; i <= maxi+1; i++) {
          for (j = maxj-1; j <= maxj+1; j++) {
            if (i >= 0 && j >= 0 && i < row && j < col && grid[i][j].worthOpen && !grid[i][j].isOpen) {
              arrayOpen.push([i,j]);
            }
          }
        }
        rand = Math.floor(Math.random() * arrayOpen.length);
        [di,dj] = arrayOpen[rand];
      }
      
      // ç”µè„‘æ‰“å¼€æ–¹å—
      console.log('didj: ' + di + ' ' + dj);
      if (!grid[di][dj].isOpen) {
        block_comp_open(di,dj);
      }
    }


    //ç©å®¶æ‰“å¼€æ–¹æ ¼å‡½æ•°
    function block_open(_i, _j) {

      let block = grid[_i][_j];
      op(block);

      //è®¾å®šæ‰“å¼€æ–¹æ ¼çš„çŠ¶æ€ä¸æ ·å¼
      function op(block) {
        block.isOpen = true; //isOpenä¸ºè‡ªå®šä¹‰å±æ€§ï¼Œè®¾ç½®ä¸ºtrueä»£è¡¨å·²æ‰“å¼€
        block.worthOpen = false;
        if (block.isMine) {
          block.style.background = 'rgb(255, 188, 235)';
        }
        else {
          block.style.background = 'rgb(248, 246, 218)';
        } 
        block.style.cursor = 'default'; //å°†é¼ æ ‡åœç•™æ ·å¼è®¾ç½®ä¸ºé»˜è®¤
      }

      if (block.isMine) {
        block.innerHTML = 'ğŸ“';
        playerScole++;
        playerScolePara.innerHTML = 'ç©å®¶å¾—åˆ†ï¼š' + playerScole;
      } 
      else if (block.tip === 0) {
        //æ‰“å¼€è®¡é›·æ•°ä¸º0çš„æ–¹æ ¼
        //éå†ä¹å®«æ ¼å†…çš„æ–¹æ ¼
        for (let i = _i - 1; i < _i + 2; i++) {
          for (let j = _j - 1; j < _j + 2; j++) {
            //åˆ¤æ–­æ˜¯å¦è¶Šç•Œ&&è·³è¿‡å·²æ‰“å¼€çš„æ–¹æ ¼&&éé›·
            if (i > -1 && j > -1 && i < row && j < col && !grid[i][j].isOpen && !grid[i][j].ismine) {
              //é€’å½’æ‰“å¼€æ–¹æ ¼å‡½æ•°
              block_open(i, j);
            }
          }
        }
      } 
      else {
        //æ‰“å¼€è®¡é›·æ•°ä¸ä¸º0çš„æ–¹æ ¼
        block.innerHTML = block.tip; //æ˜¾ç¤ºè®¡é›·æ•°
        switch (block.tip) {
          case 1:
            block.style.color = '#4876FF'; break;
          case 2: 
            block.style.color = '#008B45'; break;
          case 3:
            block.style.color = '#CD5555'; break;
          case 4:
            block.style.color = '#0000CD'; break;
          case 5:
            block.style.color = '#FFB90F'; break;
          case 6:
            block.style.color = '#FF7F00'; break;
          case 7:
            block.style.color = '#00EEEE'; break;
          case 8:
            block.style.color = '#FF0000'; break;
        }
      }
    }


    //ç”µè„‘æ‰“å¼€æ–¹æ ¼å‡½æ•°
    function block_comp_open(_i, _j) {

      let block = grid[_i][_j];
      op(block);

      //è®¾å®šæ‰“å¼€æ–¹æ ¼çš„çŠ¶æ€ä¸æ ·å¼
      function op(block) {
        block.isOpen = true; //isOpenä¸ºè‡ªå®šä¹‰å±æ€§ï¼Œè®¾ç½®ä¸ºtrueä»£è¡¨å·²æ‰“å¼€
        block.worthOpen = false;
        block.style.animation =  'rotate 0.5s';
        if (block.isMine) {
          block.style.background = 'rgb(255, 188, 235)';
        }
        else {
          block.style.background = 'rgb(248, 246, 218)';
        } 
        block.style.cursor = 'default'; //å°†é¼ æ ‡åœç•™æ ·å¼è®¾ç½®ä¸ºé»˜è®¤
      }

      if (block.isMine) {
        block.innerHTML = 'ğŸ“';
        computerScole++;
        computerScolePara.innerHTML = 'ç”µè„‘å¾—åˆ†ï¼š' + computerScole;
      } 
      else if (block.tip === 0) {
        //æ‰“å¼€è®¡é›·æ•°ä¸º0çš„æ–¹æ ¼
        //éå†ä¹å®«æ ¼å†…çš„æ–¹æ ¼
        for (let i = _i - 1; i < _i + 2; i++) {
          for (let j = _j - 1; j < _j + 2; j++) {
            //åˆ¤æ–­æ˜¯å¦è¶Šç•Œ&&è·³è¿‡å·²æ‰“å¼€çš„æ–¹æ ¼&&éé›·
            if (i > -1 && j > -1 && i < row && j < col && !grid[i][j].isOpen && !grid[i][j].ismine) {
              //é€’å½’æ‰“å¼€æ–¹æ ¼å‡½æ•°
              block_open(i, j);
            }
          }
        }
      } 
      else {
        //æ‰“å¼€è®¡é›·æ•°ä¸ä¸º0çš„æ–¹æ ¼
        block.innerHTML = block.tip; //æ˜¾ç¤ºè®¡é›·æ•°
        switch (block.tip) {
          case 1:
            block.style.color = '#4876FF'; break;
          case 2: 
            block.style.color = '#008B45'; break;
          case 3:
            block.style.color = '#CD5555'; break;
          case 4:
            block.style.color = '#0000CD'; break;
          case 5:
            block.style.color = '#FFB90F'; break;
          case 6:
            block.style.color = '#FF7F00'; break;
          case 7:
            block.style.color = '#00EEEE'; break;
          case 8:
            block.style.color = '#FF0000'; break;
        }
      }
    }


    // å¼€å§‹æ¸¸æˆæŒ‰é’®
    function clickButton() {
      grid = init_grid();
      proMat = init_proMat();
      playerScole = 0;
      computerScole = 0;
      playerScolePara.innerHTML = 'ç©å®¶å¾—åˆ†ï¼š0';
      computerScolePara.innerHTML = 'ç”µè„‘å¾—åˆ†ï¼š0';
      startGameAnimation();
      //ç”Ÿæˆåœ°é›·
      let count = 0;
      while (count < maxCount) {

        //ç”Ÿæˆéšæœºåæ ‡
        let ri = Math.floor(Math.random() * row);
        let rj = Math.floor(Math.random() * col);

        if (!grid[ri][rj].isMine) {
          grid[ri][rj].isMine = true; //è‡ªå®šä¹‰å±æ€§isMineä»£è¡¨æ–¹æ ¼ä¸ºåœ°é›·
          count++; //å½“å‰åœ°é›·æ•°+1
        }
      }
      genTips();
    }
    button.addEventListener('click',clickButton);
    

    // ç”Ÿæˆæç¤º
    function genTips() {
      for (let i = 0; i < row; i++) {
          for (let j = 0; j < col; j++) {
            // æœç´¢ä¸­å¿ƒç‚¹å‘¨å›´3Ã—3åŒºåŸŸå†…é›·çš„æ•°é‡
            count = 0;
            for (let si = i-1; si <= i+1; si++ ) {
              for (let sj = j-1; sj <= j+1; sj++) {
                if (si >= 0 && si < row && sj >= 0 && sj < col && grid[si][sj].isMine) {
                    count++
                }
              }
            }
            grid[i][j].tip = count;
          }
      }
    }

    // ç‚¹å‡»å¼€å§‹æ¸¸æˆæŒ‰é’®åŠ¨ç”»
    function startGameAnimation() {
      // å¼€å­—æ•°ç»„
      Kai = [[2,3],[2,4],[2,5],[2,6],[2,7],[2,8],[3,4],[3,7],[4,4],[4,7],[5,1],[5,2],[5,3],[5,4],[5,5],[5,6],[5,7],[5,8],[5,9],[5,10],
      [6,4],[6,7],[7,4],[7,7],[8,3],[8,7],[9,2],[9,7],[10,7]];
      Shi = [[2,3],[2,9],[3,3],[3,8],[4,2],[4,7],[4,10],[5,0],[5,1],[5,2],[5,3],[5,4],[5,6],[5,7],[5,8],[5,9],[5,10],[5,11],[6,2],[6,4],[7,1],
      [7,3],[7,7],[7,8],[7,9],[7,10],[8,2],[8,7],[8,10],[9,1],[9,3],[9,7],[9,10],[10,4],[10,7],[10,8],[10,9],[10,10]];

      // å°†â€œå¼€â€å’Œâ€œå§‹â€å†™æˆä¸€ä¸ªå¤§æ•°ç»„
      for (i = 0; i < Kai.length; i++) {
          Kai[i][1] += 12;
        }
        for (i = 0; i < Shi.length; i++) {
          Shi[i][1] += 24;
        }
        KaiShi = new Array();
        for (i = 0; i < Kai.length; i++) {
          KaiShi.push(Kai[i]);
        }
        for (i = 0; i < Shi.length; i++) {
          KaiShi.push(Shi[i]);
      }

      // ç¦æ­¢åœ¨åŠ¨ç”»æœŸé—´æœ‰é¼ æ ‡è¾“å…¥
      for (i = 0; i < row; i++) {
        for (j = 0; j < col; j++) {
          grid[i][j].classList.add('banClick');
        }
      }
      
      setTimeout(bgmStart,1);
      function bgmStart() {
        bgm.currentTime = 0;
        bgm.volume = 0.5;
        bgm.play();
      }

      function display() {
          // å…³æ³¨è¯é¢˜ï¼šæ·±æ‹·è´/æµ…æ‹·è´
          var KaiShi_temp = JSON.parse(JSON.stringify(KaiShi))

          if (count > 2*row-1) {
            clearInterval(intervalID);
          }

          for (p = 0; p < KaiShi_temp.length; p++) {
            KaiShi_temp[p][1] -= count;
          }
          
          for (p = 0; p < row; p++) {
            for (q = 0; q < col; q++) {
              grid[p][q].style.background = '#00BFFF';
            }
          }

          for (p = 0; p < KaiShi_temp.length; p++) {
            [m,n] = KaiShi_temp[p];
            if (n >=0 && n < col) {
              grid[m][n].style.background = 'rgb(255, 188, 235)';
            }
          }
          count++;
          console.log(count);
      }
      count = 0;
      intervalID = setInterval(display,50);
      
    
      setTimeout(recover,2000);
      function recover() {
        // æ¢å¤èƒŒæ™¯é¢œè‰²
        for (i = 0; i < row; i++) {
            for (j = 0; j < col; j++) {
                grid[i][j].style.background = 'rgb(117, 182, 117)';
            }
        }
        // æ¢å¤é¼ æ ‡è¾“å…¥
        for (i = 0; i < row; i++) {
        for (j = 0; j < col; j++) {
          grid[i][j].classList.remove('banClick');
          }
        }
      }
    }

  </script>
</body>

</html>